<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Employee Dashboard | Fixit</title>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet" />
  <style>
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: 'Poppins', sans-serif;
      background-color: #121212;
      color: #e0e0e0;
      padding: 20px;
    }

    header {
      text-align: center;
      font-size: 2rem;
      color: #4ff75d;
      margin-bottom: 2rem;
    }

    .profile {
      background: #1e1e1e;
      padding: 1rem 2rem;
      border-radius: 10px;
      margin-bottom: 2rem;
      box-shadow: 0 0 10px #4ff75d;
    }

    .profile h2 {
      font-size: 1.5rem;
      margin-bottom: 0.5rem;
      color: #4ff75d;
    }

    .cards {
      display: flex;
      flex-wrap: wrap;
      gap: 1rem;
      margin-bottom: 2rem;
    }

    .card {
      flex: 1 1 200px;
      background: #1f1f1f;
      border-radius: 12px;
      padding: 1.2rem;
      box-shadow: 0 0 10px #65f74f44;
      transition: transform 0.3s ease;
      text-align: center;
    }

    .card:hover {
      transform: scale(1.05);
      box-shadow: 0 0 20px #f74f4faa;
    }

    .card h3 {
      font-size: 2rem;
      color: #f62929;
    }

    .card p {
      margin-top: 0.5rem;
      font-size: 1rem;
      color:#4ff75d;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      background: #1e1e1e;
      border-radius: 12px;
      overflow: hidden;
      box-shadow: 0 0 15px #4fc5f7aa;
    }

    th, td {
      padding: 12px 16px;
      text-align: left;
      border-bottom: 1px solid #333;
      vertical-align: middle;
    }

    th {
      background: #121b0b;
      color: #e1f5fe;
    }

    td {
      color: #e0f7fa;
    }

    .status-btn {
      padding: 6px 12px;
      border: none;
      border-radius: 6px;
      font-weight: 600;
      cursor: pointer;
      transition: background 0.3s;
    }

    .in-progress {
      background-color: #fbc02d;
      color: #000;
    }

    .resolved {
      background-color: #4caf50;
      color: #fff;
    }

    .status-btn:hover {
      opacity: 0.9;
    }

    @media (max-width: 768px) {
      .cards {
        flex-direction: column;
      }

      table, th, td {
        font-size: 0.9rem;
      }
    }
    .badge {
  padding: 3px 8px;
  border-radius: 6px;
  color: white;
  font-size: 12px;
  text-transform: capitalize;
}
.badge.pending { background: orange; }
.badge.in-progress { background: royalblue; }
.badge.resolved { background: green; }
.logout-btn {
  position: absolute;
  top: 20px;
  left: 20px;
  background-color: #e53935;
  color: #fff;
  border: none;
  padding: 8px 16px;
  border-radius: 6px;
  font-weight: 600;
  cursor: pointer;
  box-shadow: 0 0 10px rgba(255, 0, 0, 0.4);
  transition: background 0.3s ease;
}

.logout-btn:hover {
  background-color: #c62828;
}
table {
  width: 100%;
  margin-bottom: 30px;
  border-collapse: collapse;
  background-color: #1a1a1a;
  color: #eee;
}
th, td {
  padding: 12px;
  text-align: left;
  border-bottom: 1px solid #333;
}
.badge.pending {
  background-color: orange;
  color: black;
  padding: 3px 7px;
  border-radius: 4px;
}
.badge.In-Progress {
  background-color: #ffc107;
  color: black;
}
.badge.Resolved {
  background-color: green;
  color: white;
}
.complaint-table {
  width: 100%;
  border-collapse: collapse;
  background-color: #121212;
  color: #fff;
  margin-bottom: 30px;
}

.complaint-table th, .complaint-table td {
  padding: 12px 15px;
  text-align: left;
  border: 1px solid #333;
  vertical-align: top;
}

.complaint-table thead {
  background-color: #1a1a1a;
  font-weight: bold;
}

.complaint-table tbody tr:nth-child(even) {
  background-color: #1f1f1f;
}

.badge {
  padding: 5px 10px;
  border-radius: 5px;
  color: white;
  font-size: 0.9rem;
}

.badge.pending {
  background-color: orange;
}

.badge.in-progress {
  background-color: blue;
}

.badge.resolved {
  background-color: green;
}

.status-btn {
  font-size: 0.85rem;
}
footer {
      background-color: #101010;
      color: #ccc;
      text-align: center;
      padding: 20px;
    }
  </style>
</head>
<body>
  <header>
  <button id="logoutBtn" class="logout-btn">Logout</button>
  Employee Dashboard
</header>

  <section class="profile">
    <h2>Welcome, <span id="empName">Employee</span></h2>
    <p>Department: <span id="empDept">Loading...</span></p>
  </section>

  <section class="cards">
    <div class="card">
      <h3 id="total">0</h3>
      <p>Total Complaints</p>
    </div>
    <div class="card">
      <h3 id="inProgress">0</h3>
      <p>In Progress</p>
    </div>
    <div class="card">
      <h3 id="resolved">0</h3>
      <p>Resolved</p>
    </div>
  </section>

  <div class="complaint-section">
  <h2 class="text-warning" style="color: orange;">Pending Complaints</h2>
  <table class="comlpaint-table">
    <thead>
  <tr>
    <th>Register No</th>
    <th>Department</th>
    <th>Section</th>
    <th>Domain</th>
    <th>Description</th>
    <th>Status</th>
    <th>Update</th>
  </tr>
</thead>

    <tbody id="pendingTable"></tbody>
  </table>
  </div>
  <div class="comlpaint-section">
  <h2 class="text-warning" style="color: rgb(225, 92, 65);">In Progress Complaints</h2>
  <table class="comlpaint-table">
    <thead>
  <tr>
    <th>Register No</th>
    <th>Department</th>
    <th>Section</th>
    <th>Domain</th>
    <th>Description</th>
    <th>Status</th>
    <th>Update</th>
  </tr>
</thead>

    <tbody id="inProgressTable"></tbody>
  </table>
</div>
<div class="comlpaint-section">
  <h2 class="text-warning" style="color: green;">Resolved Complaints</h2>
  <table class="complaint-table">
    <thead>
  <tr>
    <th>Register No</th>
    <th>Department</th>
    <th>Section</th>
    <th>Domain</th>
    <th>Description</th>
    <th>Status</th>
    <th>Update</th>
  </tr>
</thead>

    <tbody id="resolvedTable"></tbody>
  </table>
  <div id="resolveModal" style="display:none; position:fixed; top:20%; left:50%; transform:translate(-50%, -20%); background-color:#222; padding:20px; border-radius:8px; z-index:1000;">
  <h3 style="color:white;">Resolve Complaint</h3>
  <textarea id="resolveComment" placeholder="Add a comment..." style="width:100%; padding:10px; margin-bottom:10px;"></textarea>
  <input type="file" id="resolveImage" accept="image/*" />
  <br><br>
  <button onclick="submitResolve()" style="background-color:#28a745; color:white; padding:8px 16px; border:none; border-radius:5px;">Submit</button>
  <button onclick="closeResolveModal()" style="margin-left:10px; padding:8px 16px;">Cancel</button>
</div>


</section>
  <footer>Made with ❤️</footer>


  <script>
    const token = localStorage.getItem('token');
    if(!token){
      alert('You are not logged in Redirecting....');
      window.location.href='/employee-login.html';
    }
    console.log('Employee token',token);
    const API = 'https://fixit-backend-cccw.onrender.com';
let currentComplaintId = '';

function showResolveModal(id) {
  currentComplaintId = id;
  document.getElementById('resolveModal').style.display = 'block';
}

function closeResolveModal() {
  document.getElementById('resolveModal').style.display = 'none';
  currentComplaintId = '';
}

async function submitResolve() {
  const comment = document.getElementById('resolveComment').value;
  const file = document.getElementById('resolveImage').files[0];

  const formData = new FormData();
  formData.append('status', 'resolved');
  formData.append('response', comment);
  if (file) formData.append('image', file);

  try {
    const res = await fetch(`${API}/employee/update-status/${currentComplaintId}`, {
      method: 'PUT',
      headers: { 'Authorization': `Bearer ${token}` },
      body: formData
    });

    const data = await res.json();
    alert('Complaint resolved and user notified!');
    closeResolveModal();
    loadComplaints();
  } catch (err) {
    alert('Failed to resolve complaint.');
    console.error(err);
  }
}

    async function loadEmployeeDashboard() {
      try {
        const res = await fetch(`${API}/employee/profile`, {
          method:'GET',
          headers: {
            'Content-Type':'application/json',
            'Authorization': `Bearer ${token} `}
        });
        const data = await res.json();
        document.getElementById('empName').textContent = data.username;
        document.getElementById('empDept').textContent = data.department;
      } catch (err) {
        console.error('Profile fetch failed:', err);
      }
    }
async function loadComplaints() {
  try {
    const res = await fetch(`${API}/employee/assigned-complaints`, {
      headers: { 'Authorization': `Bearer ${token}` }
    });
    const complaints = await res.json();
    populateComplaintTables(complaints);
    updateSummaryCounts(complaints);
  } catch (err) {
    console.error('Error loading complaints:', err);
  }
  

}
function updateSummaryCounts(complaints) {
  const total = complaints.length;
  const resolved = complaints.filter(c => c.status?.toLowerCase() === 'resolved').length;
  const inProgress = complaints.filter(c => c.status?.toLowerCase() === 'in-progress').length;

  console.log({ total, resolved, inProgress }); // ✅ Debug log

  document.getElementById('total').textContent = total;
  document.getElementById('resolved').textContent = resolved;
  document.getElementById('inProgress').textContent = inProgress;
}

   function populateComplaintTables(complaints) {
  if (!Array.isArray(complaints)) {
    console.error("Invalid complaints data:", complaints);
    return;
  }

  // Clear previous rows
  document.getElementById("pendingTable").innerHTML = "";
  document.getElementById("inProgressTable").innerHTML = "";
  document.getElementById("resolvedTable").innerHTML = "";

  complaints.forEach(c => {
    const row = document.createElement("tr");

    const buttonsHTML = c.status !== 'Resolved' ? `
      <button class="status-btn" style="background-color:#007bff; color:white; border:none; padding:5px 10px; border-radius:5px; cursor:pointer;" onclick="updateStatus('${c._id}', 'in-progress')">In Progress</button>
      <button class="status-btn" style="background-color:#28a745; color:white; border:none; padding:5px 10px; border-radius:5px; cursor:pointer; margin-left:5px;" onclick="showResolveModal('${c._id}')">Resolved</button>
    ` : '✔ Final';

    row.innerHTML = `
  <td>${c.registerNumber || 'N/A'}</td>
  <td>${c.department || 'N/A'}</td>
  <td>${c.section || 'N/A'}</td>
  <td>${c.domain || 'N/A'}</td>
  <td><em>${c.description || 'N/A'}</em></td>
  <td><span class="badge ${c.status.toLowerCase()}">${c.status}</span></td>
  <td>${buttonsHTML}</td>
`;

    if (c.status === 'pending') {
      document.getElementById("pendingTable").appendChild(row);
    } else if (c.status === 'in-progress') {
      document.getElementById("inProgressTable").appendChild(row);
    } else {
      document.getElementById("resolvedTable").appendChild(row);
    }
  });
}


document.addEventListener('click', async (e) => {
  if (e.target.classList.contains('update-btn')) {
    const id = e.target.dataset.id;
    const statusSelect = document.querySelector(`select[data-id="${id}"]`);
    const newStatus = statusSelect.value;

    if (newStatus === 'Resolved') {
      // Prompt for response message
      const response = prompt("Enter your response to the user:");
      if (!response) return alert("Response is required.");

      // Prompt for image
      const imageInput = document.createElement('input');
      imageInput.type = 'file';
      imageInput.accept = 'image/*';

      imageInput.onchange = async () => {
        const file = imageInput.files[0];
        const formData = new FormData();
        formData.append('status', newStatus);
        formData.append('response', response);
        if (file) formData.append('image', file);

        await submitStatusUpdate(id, formData);
      };

      imageInput.click(); // Open file picker
    } else {
      // Other status changes
      await submitStatusUpdate(id, JSON.stringify({ status: newStatus }), true);
    }
  }
});
async function submitStatusUpdate(id, data, isJson = false) {
  try {
    const res = await fetch(`${API}/employee/update-status/${id}`, {
      method: 'PUT',
      headers: isJson ? {
        'Content-Type': 'application/json',
        'Authorization': `Bearer ${token}`
      } : {
        'Authorization': `Bearer ${token}`
      },
      body: data
    });

    const result = await res.json();
    if (!res.ok) throw new Error(result.message || 'Update failed');

    alert('Complaint status updated successfully');
    loadComplaints();
  } catch (err) {
    console.error('Update error:', err);
    alert('Failed to update complaint');
  }
}

    async function updateStatus(id, status) {
  try {
    const res = await fetch(`http://localhost:5000/api/employee/update-status/${id}`, {
      method: 'PUT',
      headers: {
        'Content-Type': 'application/json',
        'Authorization': `Bearer ${token}`
      },
      body: JSON.stringify({ status })
    });
    
    if (!res.ok) throw new Error('Failed to update status');

    const data = await res.json();
    alert('Status updated to ' + status);
    loadComplaints();
  } catch (err) {
    console.error('Error updating status:', err);
    alert('Error updating complaint');
  }
}
document.getElementById('logoutBtn').addEventListener('click', () => {
    localStorage.removeItem('token'); // For employee dashboard
    window.location.href = 'index.html';
  });
    loadEmployeeDashboard();
    loadComplaints();
</script>
</body>
</html>